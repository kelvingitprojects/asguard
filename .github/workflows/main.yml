name: Asguard CI/CD Pipeline

# ------------------------------------------------------------------------------
# TRIGGERS (When does this run?)
# ------------------------------------------------------------------------------
on:
  # Run on every push to the main branch
  push:
    branches: [ "main" ]
  # Run on every pull request targeting the main branch
  pull_request:
    branches: [ "main" ]
  # Allow manual triggering from the GitHub Actions tab
  workflow_dispatch:

# ------------------------------------------------------------------------------
# ENVIRONMENT VARIABLES
# ------------------------------------------------------------------------------
env:
  NODE_VERSION: '18.x'

jobs:
  # ==============================================================================
  # JOB 1: BACKEND QUALITY & SECURITY
  # ==============================================================================
  backend-checks:
    name: Backend Checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: ğŸ—ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Security Audit
        # Checks for known vulnerabilities in dependencies
        # "|| true" ensures the build doesn't fail just for warnings, remove it to enforce strict security
        run: npm audit --audit-level=high || true

  # ==============================================================================
  # JOB 2: MOBILE TESTS
  # ==============================================================================
  mobile-test:
    name: Mobile Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile
    steps:
      - name: ğŸ—ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        # --ignore-scripts is safer for CI environments to prevent malicious scripts
        run: npm ci --ignore-scripts

      - name: ğŸ§ª Run Unit Tests
        # Runs Jest tests. --passWithNoTests ensures it doesn't fail if you haven't written tests yet.
        run: npm test -- --passWithNoTests

  # ==============================================================================
  # JOB 3: MOBILE BUILD (EAS)
  # ==============================================================================
  mobile-build:
    name: Build Android App (EAS)
    needs: [mobile-test] # Only run if tests pass
    # Only build on main branch or manual trigger (saves build minutes)
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile
    steps:
      - name: ğŸ—ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸš€ Build for Preview (Internal Distribution)
        # "preview" profile is defined in eas.json.
        # It usually builds an APK/AAB for internal testing.
        run: eas build --platform android --profile preview --non-interactive
